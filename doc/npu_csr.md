## Модуль CSR

#### Список портов:

```verilog
module npu_csr
  import npu_pkg::*;
(
  input            clk_i,
  input            arstn_i,

  // MAC interface
  CSR_BUS_SV.Slave slave_csr,

  // APB interface
  APB_BUS_SV.Slave slave_apb
);
```

CSR_BUS_SV.Slave [slave_csr](npu_csr_bus.md) — ***CSR шина для передачи параметров в MAC***

APB_BUS_SV.Slave [slave_apb](npu_apb_bus.md) — ***APB шина для записи параметров в CSR***

---

#### Конфигурационные регистры CSR

Состоят из регистров для управления работой ускорителя и мониторинга его статуса

Адрес | Название       | MAC access | APB access | Размер | Диапазон значений        | Описание                                                               |
----- | -------------- | ---------- | ---------- | ------ | ------------------------ | ---------------------------------------------------------------------- |
0x0   | CSR_STATUS     | WO         | RO         |  1-bit | [0:1]                    | Хранит состояние модуля. 1 – идет вычисление. 0 – состояние ожидания     |
0x4   | CSR_CONTROL    | RO         | WO         |  1-bit | [0:1]                    | Запись 1 в регистр, пока MAC в состоянии ожидания, запускает вычисление |
| <div></div>                                                                                                                                                 |
0x8   | CSR_ADDR_T0    | RO         | RW         | 32-bit | [0:4294967295]           | Хранит адрес для чтения тензора 0 в ОЗУ                                |
0xC   | CSR_ADDR_T1    | RO         | RW         | 32-bit | [0:4294967295]           | Хранит адрес для чтения тензора 1 в ОЗУ                                |
0x10  | CSR_ADDR_T2    | RO         | RW         | 32-bit | [0:4294967295]           | Хранит адрес для чтения тензора 2 в ОЗУ                                |
| <div></div>                                                                                                                                                 |
0x14  | CSR_ADDR_T0_0  | RO         | RW         | 10-bit | [1:512]                  | Хранит количество строк тензора 0                                      |
0x18  | CSR_ADDR_T0_1  | RO         | RW         | 10-bit | [1:512]                  | Хранит количество столбцов тензора 0                                   |
0x1С  | CSR_ADDR_T0_2  | RO         | RW         |  6-bit | [1:32]                   | Хранит глубину тензора 0                                               |
0x20  | CSR_ADDR_T1_0  | RO         | RW         |  5-bit | [1:16]                   | Хранит количество строк тензора 1                                      |
0x24  | CSR_ADDR_T1_1  | RO         | RW         |  5-bit | [1:16]                   | Хранит количество столбцов тензора 1                                   |
0x28  | CSR_ADDR_T1_2  | RO         | RW         |  6-bit | [1:32]                   | Хранит глубину тензора 1                                               |
0x2С  | CSR_ADDR_T2_0  | RO         | RW         | 10-bit | [1:512]                  | Хранит количество строк тензора 2                                      |
0x30  | CSR_ADDR_T2_1  | RO         | RW         | 10-bit | [1:512]                  | Хранит количество столбцов тензора 2                                   |
0x34  | CSR_ADDR_T2_2  | RO         | RW         | 11-bit | [1:1024]                 | Хранит глубину тензора 2 (произведение глубины тензоров 0 и 1 )        |
| <div></div>                                                                                                                                                 |
0x38  | CSR_ZP_T0      | RO         | RW         |  8-bit | [-128:127]               | Хранит **$signed** параметр ZERO_POINT  тензора 0                      |
0x3С  | CSR_ZP_T1      | RO         | RW         |  8-bit | [-128:127]               | Хранит **$signed** параметр ZERO_POINT  тензора 1                      |
0x40  | CSR_ZP_T2      | RO         | RW         |  8-bit | [-128:127]               | Хранит **$signed** параметр ZERO_POINT  тензора 2                      |
| <div></div>                                                                                                                                                 |
0x44  | CSR_BIAS_T2    | RO         | RW         | 32-bit | [-2147483648:2147483647] | Хранит **$signed** параметр BIAS  тензора 2                            |
0x48  | CSR_SCALE_T2   | RO         | RW         | 32-bit | [1073741824:2147483647]  | Хранит **$signed** параметр SCALE тензора 2                            |
0x4С  | CSR_SHIFT_T2   | RO         | RW         |  5-bit | [0:31]                   | Хранит параметр SHIFT тензора 2                                        |


**Примечание:** Стоит обратить внимание, что размерности матрицы не могуть быть нулевыми, минимальная размерность матрицы по трём измерениям — 1x1.

---

#### Общая информация

Модуль работает по принципу классического CSR:

 * Запись в регистры — операция CSRW_OP;
 * Чтение регистров — операция CSRR_OP.

---

Типы регистров (по доступу со стороны APB bus):

 * RO — Read only  (регистры только для чтения);
 * WO — Write only (регистры только для записи);
 * RW — Read Write (регистры которые можно читать и перезаписывать).

 - Присутствует проверка на нелегальный адрес (попытка обращения к нереализованному регистру / несуществующему адресу).  
 - Присутствует проверка типа операции при обращении к CSR регистрам.  
 - Исключением является попытка записи в RO регистр, в случае, если данные для записи равны нулю.

---

Типы регистров (по доступу со стороны MAC по CSR bus):

 * RO — Read only (регистры только для чтения);
 * WO — Write only (регистры которые можно только перезаписывать).

CSR шина даёт возможность модулю MAC комбинаторно читать CSR регистры;

Сам MAC модуль может устанавливать только значение в регистре CSR_STATUS.

 * CSR_STATUS == 1'b0 — MAC находится в состоянии ожидания (готов к вычислениям);
 * CSR_STATUS == 1'b1 — MAC находится в состоянии вычисления, единица поднимается на слшедующий такт после установки единицы в регистре CSR_CONTROL;
 * В случае, если MAC закончил вычисления, а в регистре CSR_CONTROL установлена единица, то MAC начнёт новый этап вычислений над данными, указанными в CSR.

---

#### Запуск работы MAC посредством записи в CSR_CONTROL

Регистр **CSR_CONTROL** работает следующим образом:

При попытке записи по данному адресу ( 32'h04 ) значение младшего разряда, подаваемое по шине APB ( slave_apb.p_wdata[0] ), будет комбинаторно установлено на CSR шине ( slave_csr.csr_control = CSR_CONTROL ), посредством чего попадёт в CU, управляющий блоком MAC.

Если в регистр будет записываться 1'b1, то MAC начнёт вычисления. На следующий такт, после записи 1'b1 в CSR_CONTROL, MAC должен выставить на CSR_STATUS статус "CALC = 1'b1", сигнализирующий о том, что вычисление начато. Если в CSR_CONTROL производится запись 1'b0, то MAC продолжит оставаться в режиме ожидания (определяется устройством конечного автомата, отвечающего за работу MAC).

В остальное время, когда в запись в CSR_CONTROL не производится, его значения устанавливается в 1'b0.

Запись в CSR_CONTROL 1'b1 со стороны APB должна производиться после установки в регистре CSR_STATUS значения 0, что соответствует переходу MAC в состояние ожидания (готовность к началу нового вычисления).

---
---