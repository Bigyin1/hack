# Инструкция по запуску верификационного окружения

## Общая информация

**Корректность функциональной работы** дизайна и его [синтезированного нетлиста](#запуск-тестирования-нетлиста) проверяется при помощи верификационного окружения, расположенного в директории `dv/`.

## Настройка

Для настройки верификационного окружения необходимо выполнить команды:

```bash
export QUESTA_MVC_HOME=/local/tools/mentor/QUESTA_VERIFICATION_IP/2020.4_1
module load mentor/QUESTA_ULTRA/2021.1
```

Данная команда сделает доступным запуск QuestaSim в текущей сессии терминала. Это значит, что **её нужно выполнять каждый раз при открытии нового терминала**.

## Запуск

Для запуска верификационного окружения используется Makefile, расположенный в директории `dv/build/`.

Пользователю рекомендуется запускать тестирование в режиме GUI:

```bash
make clean && make GUI=1 TEST=<название-теста>
```

Вместо `<название-теста>` необходимо вписать название из [списка доступных тестов](#тесты-для-проверки-дизайна).

## Тесты для проверки дизайна

Итоговый дизайн будет проверяться на закрытой симуляции на тесте `npu_full_tensor_test` с особыми настройками и зерном рандомизации.

Тест состоит из N вызываемых операций над тензорами. Между операциями меняется размерность входных и выходных тензоров. Тест завершается, когда результат последней операции полностью записан в ОЗУ и модуль перешел в состояние ожидания.

Для запуска теста пользователем выполняется команда:

```bash
make clean && make GUI=1 TEST=npu_full_tensor_test
```

В силу длительности теста `npu_full_tensor_test` рекомендуется производить отладку на тестах:

- `npu_small_tensor_test`;
- `npu_playground_tensor_test`.

В тесте `npu_small_tensor_test` NPU выполняет операции над матрицами относительно небольших размерностей.

В тесте `npu_playground_tensor_test` пользователь может самостоятельно задать размеры тензоров через командную строку, например:

```bash
make clean && make GUI=1 TEST=npu_playground_tensor_test ADDR_T0_0=4 ADDR_T0_1=4 ADDR_T0_2=3 ADDR_T1_0=4 ADDR_T1_1=4 ADDR_T1_2=3
```

**История запуска** сохраняется в файл `run_history.log`.

## Дополнительные флаги симуляции

- `ITER_AM` - количество итераций работы над тензорами в симуляции;
- `TIMEOUT` - таймаут в отсчетах тактового сигнала одной итерации работы над тензорами в симуляции.

Пример:

```bash
make clean && make GUI=1 TEST=npu_small_tensor_test ITER_AM=10 TIMEOUT=500000
```

## Маршрут верификации

После выполнения команды запуска тестового сценария будет происходить компиляция исходных файлов, а за ней запуск тестового сценария. Статусы выполнения будут сохраняться в **выходную директорию**.

По умолчанию **выходной директорией является `dv/build/out/`**.

В ходе компиляции и запуска могут возникнуть ошибки, информацию о которых можно получить из соответствующих лог-файлов:
 
- `dv/build/out/rtl_compile.log` - лог компиляции дизайна;
- `dv/build/out/seed-<число>/<название-теста>/rtl_run.log` - лог запуска тестирования.

При успешной компиляции будет запущен GUI симулятора QuestaSim (если в `make` был передан флаг `GUI=1`):

## Запуск тестирования нетлиста

Одним из требований к модифицированному дизайну является коректная работа его синтезированного нетлиста.

Перед запуском симуляции нетлиста **необходимо убедиться в том, что он был получен при помощи команды `make syn_build`, запущенной из корневой директории репозитория.**

Для запуска симуляции нетлиста необходимо запустить `make` с аргументом `NETLIST=1`. Например:

```bash
make clean && make GUI=1 DEBUG=0 NETLIST=1 TEST=npu_small_tensor_test
```

Процесс работы с симуляцией нетлиста схож с процессом работы с симуляцией RTL. **Настоятельно рекомендуется запускать тестирование нетлиста с флагом `DEBUG=0`.**
